# SPDX-License-Identifier: ((GPL-2.0 WITH Linux-syscall-note) OR BSD-3-Clause)

name: net_shaper

doc: Network HW Rate Limiting offload

definitions:
  -
    type: enum
    name: scope
    doc: the different scopes where a shaper can be attached
    entries:
      - name: unspec
        doc: The scope is not specified
      -
        name: port
        doc: The root shaper for the whole H/W.
      -
        name: netdev
        doc: The main shaper for the given network device.
      -
        name: queue
        doc: The shaper is attached to the given device queue.
      -
        name: detached
        doc: |
             The shaper can be attached to port, netdev or other
             detached shapers, allowing nesting and grouping of
             netdev or queues.
    render-max: true
  -
    type: enum
    name: metric
    doc: different metric each shaper can support
    entries:
      -
        name: bps
        doc: Shaper operates on a bits per second basis
      -
        name: pps
        doc: Shaper operates on a packets per second basis

attribute-sets:
  -
    name: net_shaper
    attributes:
      -
        name: ifindex
        type: u32
      -
        name: parent
        type: nest
        nested-attributes: handle
      -
        name: handle
        type: nest
        nested-attributes: handle
      -
        name: metric
        type: u32
        enum: metric
      -
        name: bw-min
        type: u64
      -
        name: bw-max
        type: u64
      -
        name: burst
        type: u64
      -
        name: priority
        type: u32
      -
        name: weight
        type: u32
      -
        name: scope
        type: u32
        enum: scope
      -
        name: id
        type: u32
      -
         name: handles
         type: nest
         multi-attr: true
         nested-attributes: handle
      -
        name: shapers
        type: nest
        multi-attr: true
        nested-attributes: ns-info
      -
        name: modified
        type: u32
      -
        name: pad
        type: pad
  -
    name: handle
    subset-of: net_shaper
    attributes:
      -
        name: scope
      -
        name: id
  -
    name: ns-info
    subset-of: net_shaper
    attributes:
      -
        name: parent
      -
        name: handle
      -
        name: metric
      -
        name: bw-min
      -
        name: bw-max
      -
        name: burst
      -
        name: priority
      -
        name: weight
  -
    name: capabilities
    attributes:
      -
        name: ifindex
        type: u32
      -
        name: scope
        type: u32
        enum: scope
      -
        name: support-metric-bps
        doc: the device accepts 'bps' metric for bw-min, bw-max and burst
        type: flag
      -
        name: support-metric-pps
        doc: the device accepts 'pps' metric for bw-min, bw-max and burst
        type: flag
      -
        name: support-nesting
        doc: |
          the device supports nesting shaper belonging to this scope
          below 'detached' scoped shapers. Only 'queue', 'netdev' and
          'detached' scope and flag 'support-nesting'.
        type: flag
      -
        name: support-bw-min
        doc: the device supports a minimum guaranteed bw
        type: flag
      -
        name: support-bw-max
        doc: the device supports maximum bw shaping
        type: flag
      -
        name: support-burst
        doc: the device supports a maximum burst size
        type: flag
      -
        name: support-priority
        doc: the device supports priority scheduling
        type: flag
      -
        name: support-weight
        doc: the device supports weighted round robin scheduling
        type: flag

operations:
  list:
    -
      name: get
      doc: |
        Get / Dump information about a/all the shaper for a given device
      attribute-set: net_shaper
      flags: [ admin-perm ]

      do:
        request:
          attributes:
            - ifindex
            - handle
        reply:
          attributes: &ns-attrs
            - parent
            - handle
            - metric
            - bw-min
            - bw-max
            - burst
            - priority
            - weight

      dump:
        request:
          attributes:
            - ifindex
        reply:
          attributes: *ns-attrs
    -
      name: set
      doc: |
        Create or configures the specified shapers.
        The update is atomic with respect to all shaper
        affected by a single command, and is allowed to
        affect a subset of the specified shapers, e.g.
        due to H/W resources exhaustion. In such case
        the update stops at the first failure, the extack
        is set accordingly.
      attribute-set: net_shaper
      flags: [ admin-perm ]

      do:
        request:
          attributes:
            - ifindex
            - shapers
        reply:
          attributes:
            - modified

    -
      name: delete
      doc: |
        Clear (remove) the specified shaper.
        The update is atomic with respect to all shaper
        affected by a single command, and is allowed to
        affect a subset of the specified shapers, e.g.
        due to H/W resources exhaustion. In such case
        the update stops at the first failure, the extack
        is set accordingly.
      attribute-set: net_shaper
      flags: [ admin-perm ]

      do:
        request:
          attributes:
            - ifindex
            - handles
        reply:
          attributes:
            - modified

    -
      name: cap-get
      doc: |
        Get / Dump the shaper capabilities supported by the given device
      attribute-set: capabilities

      do:
        request:
          attributes:
            - ifindex
            - scope
        reply:
          attributes: &cap-attrs
            - support-metric-bps
            - support-metric-pps
            - support-nesting
            - support-bw-min
            - support-bw-max
            - support-burst
            - support-priority
            - support-weight

      dump:
        request:
          attributes:
            - ifindex
        reply:
          attributes: *cap-attrs
